<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FHIR 病患資料管理系統</title>

  <!-- 外部樣式表 -->
  <link rel="stylesheet" href="style.css" />
  <script src="./fhir.js" defer></script>
</head>
<body>
    <div class="container">
        <h1>FHIR 病患資料管理系統</h1>
        
        <div class="form-section">
            <h2>病患初診資料表</h2>
            <div id="statusMessage"></div>
            
            <form id="patientForm">
                <div class="form-row">
                    <label for="name">姓名 *</label>
                    <input type="text" id="name" required>
                </div>
                
                <div class="form-row">
                    <label for="birthDate">出生日期 *</label>
                    <input type="date" id="birthDate" required>
                </div>
                
                <div class="form-row">
                    <label>性別 *</label>
                    <div class="gender-group">
                        <div class="gender-option">
                            <input type="radio" name="gender" id="gender_male" value="male" required>
                            <label for="gender_male">男</label>
                        </div>
                        <div class="gender-option">
                            <input type="radio" name="gender" id="gender_female" value="female" required>
                            <label for="gender_female">女</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <label for="uid">身分證字號</label>
                    <input type="text" id="uid">
                </div>
                
                <div class="form-row">
                    <label for="phone_work">連絡電話（公）</label>
                    <input type="text" id="phone_work">
                </div>
                
                <div class="form-row">
                    <label for="phone_home">連絡電話（宅）</label>
                    <input type="text" id="phone_home">
                </div>
                
                <div class="form-row">
                    <label for="phone_mobile">連絡電話（手機）</label>
                    <input type="text" id="phone_mobile">
                </div>
                
                <div class="form-row">
                    <label for="address">聯絡地址</label>
                    <input type="text" id="address" placeholder="例：高雄市小港區大馬路999號">
                </div>
                
                <div class="form-row">
                    <label for="mail">電子信箱</label>
                    <input type="text" id="mail">
                </div>
                
                <div class="emergency-section">
                    <div class="section-title">緊急聯絡人資訊</div>
                    
                    <div class="form-row">
                        <label for="contact_name">緊急聯絡人－姓名</label>
                        <input type="text" id="contact_name">
                    </div>
                    
                    <div class="form-row">
                        <label for="contact_relationship">緊急聯絡人－關係</label>
                        <input type="text" id="contact_relationship">
                    </div>
                    
                    <div class="form-row">
                        <label for="contact_phone">緊急聯絡人－聯絡電話</label>
                        <input type="text" id="contact_phone">
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn-primary" onclick="uploadFhirData()">上傳資料</button>
                    <button type="button" class="btn-secondary" onclick="loadSampleData()">載入範例資料</button>
                    <button type="button" class="btn-tertiary" onclick="clearForm()">清除表單</button>
                </div>
            </form>
        </div>
        
        <div class="fhir-section">
            <h2>FHIR 格式輸出</h2>
            <div class="fhir-output" id="fhir-output">
                點擊「上傳資料」按鈕來查看 FHIR 格式的病患資料...
            </div>
        </div>
    </div>

    <script>
        // 範例病患資料
        const samplePatientData = {
            name: "王大明",
            birthDate: "1995-01-01",
            gender: "male",
            uid: "A123456789",
            phone_mobile: "0912345678",
            address: "高雄市小港區大馬路999號",
            contact_name: "王小華",
            contact_relationship: "配偶",
            contact_phone: "0987654321"
        };

        // 轉換為 FHIR 格式
        function convertToFhir(data) {
            // 解析地址資訊
            const addressParts = parseAddress(data.address);
            
            const fhirData = {
                resourceType: "Patient",
                identifier: data.uid ? [{
                    use: "official",
                    type: {
                        system: "http://terminology.hl7.org/CodeSystem/v2-0203",
                        code: "NI",
                        display: "身分證字號"
                    },
                    value: data.uid
                }] : [],
                name: [{
                    use: "official",
                    text: data.name,
                    family: data.name ? data.name.charAt(0) : "",
                    given: data.name ? [data.name.substring(1)] : []
                }],
                birthDate: data.birthDate,
                gender: data.gender,
                telecom: [],
                address: data.address ? [addressParts] : [],
                contact: []
            };

            // 添加電話資訊
            if (data.phone_home) {
                fhirData.telecom.push({
                    system: "phone",
                    value: data.phone_home,
                    use: "home"
                });
            }
            if (data.phone_work) {
                fhirData.telecom.push({
                    system: "phone",
                    value: data.phone_work,
                    use: "work"
                });
            }
            if (data.phone_mobile) {
                fhirData.telecom.push({
                    system: "phone",
                    value: data.phone_mobile,
                    use: "mobile"
                });
            }
            if (data.mail) {
                fhirData.telecom.push({
                    system: "email",
                    value: data.mail,
                    use: "home"
                });
            }

            // 添加緊急聯絡人
            if (data.contact_name) {
                fhirData.contact.push({
                    relationship: [{
                        text: data.contact_relationship || "未指定"
                    }],
                    name: {
                        use: "official",
                        text: data.contact_name
                    },
                    telecom: data.contact_phone ? [{
                        system: "phone",
                        value: data.contact_phone,
                        use: "home"
                    }] : []
                });
            }

            return fhirData;
        }

        // 解析地址
        function parseAddress(addressText) {
            if (!addressText) return {};
            
            // 簡單的台灣地址解析
            const cityMatch = addressText.match(/(台北市|新北市|桃園市|台中市|台南市|高雄市|基隆市|新竹市|嘉義市|新竹縣|苗栗縣|彰化縣|南投縣|雲林縣|嘉義縣|屏東縣|宜蘭縣|花蓮縣|台東縣|澎湖縣|金門縣|連江縣)/);
            const districtMatch = addressText.match(/([^市縣]*區|[^市縣]*鄉|[^市縣]*鎮)/);
            
            return {
                use: "home",
                type: "physical",
                text: addressText,
                line: [addressText.replace(cityMatch?.[0] || "", "").replace(districtMatch?.[0] || "", "")],
                city: cityMatch?.[0] || "",
                district: districtMatch?.[0] || "",
                country: "TW"
            };
        }

        // 從表單收集資料並轉換
        function uploadFhirData() {
            try {
                const data = {
                    name: document.getElementById("name").value,
                    birthDate: document.getElementById("birthDate").value,
                    gender: document.querySelector('input[name="gender"]:checked')?.value,
                    uid: document.getElementById("uid").value,
                    phone_work: document.getElementById("phone_work").value,
                    phone_home: document.getElementById("phone_home").value,
                    phone_mobile: document.getElementById("phone_mobile").value,
                    address: document.getElementById("address").value,
                    mail: document.getElementById("mail").value,
                    contact_name: document.getElementById("contact_name").value,
                    contact_relationship: document.getElementById("contact_relationship").value,
                    contact_phone: document.getElementById("contact_phone").value
                };

                // 驗證必填欄位
                if (!data.name || !data.birthDate || !data.gender) {
                    showMessage('請填寫姓名、出生日期和性別等必填欄位', 'error');
                    return;
                }

                const fhirData = convertToFhir(data);
                document.getElementById("fhir-output").textContent = JSON.stringify(fhirData, null, 2);
                
                console.log('FHIR 資料:', fhirData);
                showMessage('成功轉換為 FHIR 格式！', 'success');
                
            } catch (error) {
                console.error('轉換過程發生錯誤:', error);
                showMessage('轉換過程發生錯誤：' + error.message, 'error');
            }
        }

        // 載入範例資料
        function loadSampleData() {
            document.getElementById("name").value = samplePatientData.name;
            document.getElementById("birthDate").value = samplePatientData.birthDate;
            document.getElementById("gender_" + samplePatientData.gender).checked = true;
            document.getElementById("uid").value = samplePatientData.uid;
            document.getElementById("phone_mobile").value = samplePatientData.phone_mobile;
            document.getElementById("address").value = samplePatientData.address;
            document.getElementById("contact_name").value = samplePatientData.contact_name;
            document.getElementById("contact_relationship").value = samplePatientData.contact_relationship;
            document.getElementById("contact_phone").value = samplePatientData.contact_phone;
            
            showMessage('已載入範例資料', 'success');
        }

        // 清除表單
        function clearForm() {
            document.getElementById("patientForm").reset();
            document.getElementById("fhir-output").textContent = "點擊「上傳資料」按鈕來查看 FHIR 格式的病患資料...";
            showMessage('表單已清除', 'success');
        }

        // 顯示狀態訊息
        function showMessage(message, type) {
            const statusDiv = document.getElementById("statusMessage");
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = "";
            }, 3000);
        }

        // 頁面載入時的初始化
        window.addEventListener('load', function() {
            console.log('FHIR 病患資料管理系統已載入');
        });
    </script>
</body>
</html>
